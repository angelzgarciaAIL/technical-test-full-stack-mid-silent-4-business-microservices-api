# Laravel API - Port 8000
upstream laravel_backend {
    server laravel:8000;
}

# Node.js API - Port 3001
upstream nodejs_backend {
    server nodejs:3001;
}

server {
    listen 80;
    server_name localhost;
    
    # Laravel API
    location /api/laravel/ {
        proxy_pass http://laravel_backend/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Remove /laravel from path
        rewrite ^/api/laravel/(.*)$ /api/$1 break;
    }
    
    # Node.js API
    location /api/node/ {
        proxy_pass http://nodejs_backend/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Remove /node from path
        rewrite ^/api/node/(.*)$ /api/$1 break;
    }
    
    # phpMyAdmin
    location /phpmyadmin/ {
        proxy_pass http://phpmyadmin/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # Health checks
    location /health {
        return 200 'OK';
        add_header Content-Type text/plain;
    }
}
